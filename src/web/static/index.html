<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Budsy - AI Testing Agent</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#eff6ff",
                100: "#dbeafe",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
              },
              secondary: {
                50: "#f8fafc",
                100: "#f1f5f9",
                500: "#64748b",
                600: "#475569",
                700: "#334155",
              },
            },
            animation: {
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              "bounce-subtle": "bounce 2s infinite",
              gradient: "gradient 6s ease infinite",
              glow: "glow 2s ease-in-out infinite alternate",
              float: "float 3s ease-in-out infinite",
              shimmer: "shimmer 2s linear infinite",
            },
            keyframes: {
              gradient: {
                "0%, 100%": {
                  "background-size": "200% 200%",
                  "background-position": "left center",
                },
                "50%": {
                  "background-size": "200% 200%",
                  "background-position": "right center",
                },
              },
              glow: {
                from: {
                  "text-shadow":
                    "0 0 20px #3b82f6, 0 0 30px #3b82f6, 0 0 40px #3b82f6",
                },
                to: {
                  "text-shadow":
                    "0 0 10px #3b82f6, 0 0 15px #3b82f6, 0 0 20px #3b82f6",
                },
              },
              float: {
                "0%, 100%": { transform: "translateY(0px)" },
                "50%": { transform: "translateY(-10px)" },
              },
              shimmer: {
                "0%": { transform: "translateX(-100%)" },
                "100%": { transform: "translateX(100%)" },
              },
            },
          },
        },
      };
    </script>
    <style>
      .professional-gradient {
        background: linear-gradient(-45deg, #0f172a, #1e293b, #334155, #475569);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
      }

      .glass-morphism {
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.2);
      }

      .glass-dark {
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.1);
      }

      .shimmer-effect {
        position: relative;
        overflow: hidden;
      }

      .shimmer-effect::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        transform: translateX(-100%);
        animation: shimmer 2s infinite;
      }

      /* Custom scrollbar for logs */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(59, 130, 246, 0.5);
        border-radius: 4px;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(59, 130, 246, 0.7);
      }

      /* Log entry animations */
      .log-entry {
        transition: all 0.3s ease;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .loading-entry {
        background: linear-gradient(
          90deg,
          transparent,
          rgba(34, 197, 94, 0.1),
          transparent
        );
        background-size: 200% 100%;
        animation: shimmer 2s linear infinite;
      }

      /* Enhanced button hover effects */
      .btn-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .btn-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900"
  >
    <!-- Animated background particles -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
      <div class="absolute -inset-10 opacity-20">
        <div
          class="absolute top-1/4 left-1/4 w-64 h-64 bg-blue-500 rounded-full mix-blend-soft-light filter blur-3xl animate-float"
        ></div>
        <div
          class="absolute top-1/3 right-1/4 w-64 h-64 bg-cyan-400 rounded-full mix-blend-soft-light filter blur-3xl animate-float"
          style="animation-delay: 2s"
        ></div>
        <div
          class="absolute bottom-1/4 left-1/3 w-64 h-64 bg-indigo-500 rounded-full mix-blend-soft-light filter blur-3xl animate-float"
          style="animation-delay: 4s"
        ></div>
      </div>
    </div>

    <div class="px-4 py-6 relative z-10">
      <!-- Header -->
      <div class="glass-morphism rounded-3xl p-8 mb-8 text-center shadow-2xl">
        <div class="flex items-center justify-center mb-4">
          <div
            class="mr-4 p-3 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl animate-bounce-subtle"
          >
            <i data-lucide="bot" class="w-8 h-8 text-white"></i>
          </div>
          <h1
            class="text-5xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent"
          >
            BUDSY
          </h1>
        </div>
        <p class="text-xl text-slate-300 mb-6 font-medium">
          AI-Powered UI Testing Agent
        </p>
        <div
          class="inline-flex items-center space-x-2 px-6 py-3 rounded-full glass-morphism shadow-lg"
          id="health-status"
        >
          <i
            data-lucide="loader"
            class="w-4 h-4 text-blue-400 animate-spin"
          ></i>
          <span class="font-medium text-slate-200"
            >Checking system health...</span
          >
        </div>
      </div>

      <!-- Main Content -->
      <div class="grid lg:grid-cols-2 gap-8">
        <!-- Test Configuration Panel -->
        <div class="glass-morphism rounded-3xl p-8 shadow-2xl">
          <div class="flex items-center mb-6">
            <div class="mr-3 p-2 bg-blue-500/20 rounded-lg">
              <i data-lucide="settings" class="w-6 h-6 text-blue-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-100">
              Test Configuration
            </h2>
          </div>

          <div id="test-alerts" class="mb-6"></div>

          <form id="test-form" class="space-y-6">
            <!-- Platform Selection -->
            <div class="space-y-2">
              <label
                for="platform"
                class="flex items-center text-sm font-semibold text-slate-200"
              >
                <i
                  data-lucide="monitor"
                  class="w-4 h-4 mr-2 text-slate-400"
                ></i>
                Platform
              </label>
              <select
                id="platform"
                name="platform"
                class="w-full px-4 py-3 rounded-xl border-2 border-slate-600 focus:border-blue-400 focus:ring-2 focus:ring-blue-300/20 transition-all duration-300 bg-slate-700/50 text-slate-100"
              >
                <option value="web">üåê Web Browser</option>
                <option value="android">üì± Android App</option>
                <option value="ios">üì± iOS App</option>
              </select>
            </div>

            <!-- Test Mode Selection -->
            <div class="space-y-2">
              <label
                for="test-mode"
                class="flex items-center text-sm font-semibold text-slate-200"
              >
                <i data-lucide="brain" class="w-4 h-4 mr-2 text-slate-400"></i>
                Test Mode
              </label>
              <select
                id="test-mode"
                name="testMode"
                class="w-full px-4 py-3 rounded-xl border-2 border-slate-600 focus:border-blue-400 focus:ring-2 focus:ring-blue-300/20 transition-all duration-300 bg-slate-700/50 text-slate-100"
              >
                <option value="visual">
                  ü§ñ AI Visual Guidance (Recommended)
                </option>
                <option value="traditional">üîç Traditional Selectors</option>
              </select>
              <div
                class="flex items-center mt-1 bg-slate-800/50 p-2 rounded-lg"
              >
                <i
                  data-lucide="lightbulb"
                  class="w-3 h-3 mr-1 text-blue-400"
                ></i>
                <p class="text-xs text-slate-400">
                  AI Visual mode uses screenshot analysis to find elements
                  automatically. No selectors needed!
                </p>
              </div>
            </div>

            <!-- URL and Expected Result Row -->
            <div class="grid md:grid-cols-2 gap-4">
              <div class="space-y-2">
                <label
                  for="url"
                  id="url-label"
                  class="flex items-center text-sm font-semibold text-slate-200"
                >
                  <i data-lucide="link" class="w-4 h-4 mr-2 text-slate-400"></i>
                  Website URL
                </label>
                <input
                  type="url"
                  id="url"
                  name="url"
                  placeholder="https://example.com"
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-600 focus:border-blue-400 focus:ring-2 focus:ring-blue-300/20 transition-all duration-300 bg-slate-700/50 text-slate-100 placeholder-slate-400"
                />
              </div>
              <div class="space-y-2">
                <label
                  for="expected-result"
                  class="flex items-center text-sm font-semibold text-slate-200"
                >
                  <i
                    data-lucide="target"
                    class="w-4 h-4 mr-2 text-slate-400"
                  ></i>
                  Expected Result (Optional)
                </label>
                <input
                  type="text"
                  id="expected-result"
                  name="expectedResult"
                  placeholder="What should happen..."
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-600 focus:border-blue-400 focus:ring-2 focus:ring-blue-300/20 transition-all duration-300 bg-slate-700/50 text-slate-100 placeholder-slate-400"
                />
              </div>
            </div>

            <!-- Test Instruction -->
            <div class="space-y-2">
              <label
                for="instruction"
                class="flex items-center text-sm font-semibold text-slate-200"
              >
                <i
                  data-lucide="file-text"
                  class="w-4 h-4 mr-2 text-slate-400"
                ></i>
                Test Instruction
              </label>
              <textarea
                id="instruction"
                name="instruction"
                rows="4"
                placeholder="Describe what you want to test in natural language...

Examples:
‚Ä¢ Click the login button and verify the login form appears
‚Ä¢ Fill out the contact form with name 'John Doe' and email 'john@test.com' and submit
‚Ä¢ Navigate to the dashboard and check if the welcome message is visible"
                class="w-full px-4 py-3 rounded-xl border-2 border-slate-600 focus:border-blue-400 focus:ring-2 focus:ring-blue-300/20 transition-all duration-300 resize-none bg-slate-700/50 text-slate-100 placeholder-slate-400"
              ></textarea>
            </div>

            <!-- Test Status -->
            <div
              id="test-status"
              class="status-idle inline-flex items-center space-x-2 px-4 py-2 rounded-full glass-morphism"
            >
              <i
                data-lucide="circle"
                class="w-5 h-5 text-green-400 fill-current"
              ></i>
              <span class="font-medium text-slate-200"
                >Ready to start testing</span
              >
            </div>

            <!-- Control Buttons -->
            <div class="flex flex-wrap gap-3">
              <button
                type="submit"
                class="btn-hover inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300"
                id="start-btn"
              >
                <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                Start Test
              </button>
              <button
                type="button"
                class="btn-hover hidden inline-flex items-center px-6 py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300"
                id="stop-btn"
              >
                <i data-lucide="square" class="w-4 h-4 mr-2"></i>
                Stop Test
              </button>
              <button
                type="button"
                class="btn-hover hidden inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-500 to-teal-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300"
                id="download-logs-btn"
              >
                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                Download Logs
              </button>
            </div>
          </form>

          <!-- Test Result -->
          <div id="test-result" class="hidden mt-8"></div>
        </div>

        <!-- Logs Panel -->
        <div
          class="glass-morphism rounded-3xl p-8 shadow-2xl flex flex-col max-h-screen"
        >
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center">
              <div class="mr-3 p-2 bg-green-500/20 rounded-lg">
                <i data-lucide="bar-chart-3" class="w-6 h-6 text-green-400"></i>
              </div>
              <h2 class="text-2xl font-bold text-slate-100">
                Live Test Execution Logs
              </h2>
            </div>
          </div>

          <!-- Logs Controls -->
          <div
            class="flex justify-between items-center mb-4 p-3 bg-slate-800/30 rounded-xl border border-slate-600/20"
          >
            <label class="flex items-center space-x-2 cursor-pointer">
              <input
                type="checkbox"
                id="auto-scroll"
                checked
                class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 bg-slate-700 border-slate-500"
              />
              <span class="text-sm font-medium text-slate-300"
                >Auto-scroll logs</span
              >
            </label>
            <button
              type="button"
              class="btn-hover inline-flex items-center px-4 py-2 bg-slate-600 hover:bg-slate-500 text-slate-200 font-medium rounded-lg transition-all duration-300 text-sm"
              id="clear-logs-btn"
            >
              <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
              Clear Logs
            </button>
          </div>

          <!-- Logs Container -->
          <div
            id="logs-container"
            class="flex-1 glass-dark rounded-2xl p-6 overflow-y-auto font-mono text-sm leading-relaxed custom-scrollbar"
          >
            <div
              class="log-entry log-info flex items-start space-x-3 mb-3 p-3 rounded-lg bg-blue-500/20 border-l-4 border-blue-400"
            >
              <span class="text-slate-500 text-xs mt-1 font-mono"
                >[System]</span
              >
              <div class="flex items-center flex-1">
                <i data-lucide="info" class="w-4 h-4 mr-2 text-blue-400"></i>
                <span class="text-blue-200 font-medium">
                  Welcome to Budsy! Configure your test above and click "Start
                  Test" to begin.
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Enhanced status indicators with Tailwind classes
      const statusClasses = {
        "status-idle": "bg-slate-700/50 text-slate-300",
        "status-running": "bg-yellow-600/30 text-yellow-200 animate-pulse",
        "status-completed": "bg-green-600/30 text-green-200",
        "status-failed": "bg-red-600/30 text-red-200",
      };

      const healthStatusClasses = {
        "status-healthy": "bg-green-600/20 text-green-200",
        "status-unhealthy": "bg-red-600/20 text-red-200",
      };

      const logLevelClasses = {
        "log-info": "bg-blue-500/20 border-blue-400 text-blue-200",
        "log-success": "bg-green-500/20 border-green-400 text-green-200",
        "log-error": "bg-red-500/20 border-red-400 text-red-200",
        "log-warn": "bg-yellow-500/20 border-yellow-400 text-yellow-200",
        "log-debug": "bg-slate-500/20 border-slate-400 text-slate-300",
      };

      const alertClasses = {
        "alert-info": "bg-blue-900/30 border-blue-600/50 text-blue-200",
        "alert-warning":
          "bg-yellow-900/30 border-yellow-600/50 text-yellow-200",
        "alert-error": "bg-red-900/30 border-red-600/50 text-red-200",
      };

      // Global state
      let socket = null;
      let currentTestId = null;
      let lastCompletedTestId = null;
      let testStartTime = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize Lucide icons
        lucide.createIcons();

        initializeSocket();
        checkSystemHealth();
        setupEventListeners();
        updatePlatformFields();
      });

      // Socket.IO connection
      function initializeSocket() {
        socket = io();

        socket.on("connect", () => {
          addLog("info", "SYSTEM", "Connected to Budsy server");
        });

        socket.on("disconnect", () => {
          addLog("error", "SYSTEM", "Disconnected from Budsy server");
        });

        socket.on("test_status", (data) => {
          updateTestStatus(data.status);
        });

        socket.on("log", (logData) => {
          addLog(
            logData.level,
            logData.component,
            logData.message,
            logData.data
          );
        });

        socket.on("test_completed", (data) => {
          handleTestCompleted(data);
        });

        socket.on("test_failed", (data) => {
          handleTestFailed(data);
        });

        socket.on("test_stopped", (data) => {
          handleTestStopped(data);
        });

        socket.on("failure_logs_ready", (data) => {
          showAlert(
            "info",
            "Failure logs have been automatically generated and are ready for download."
          );
        });
      }

      // Check system health
      async function checkSystemHealth() {
        try {
          const response = await axios.get("/api/health");
          const data = response.data;

          const healthStatus = document.getElementById("health-status");

          if (data.status === "healthy" && data.services.ai_backend) {
            healthStatus.className = `inline-flex items-center space-x-2 px-6 py-3 rounded-full glass-morphism shadow-lg ${healthStatusClasses["status-healthy"]}`;
            healthStatus.innerHTML =
              '<i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i><span class="font-medium">All systems operational</span>';
            addLog(
              "success",
              "SYSTEM",
              "Health check passed - All services operational"
            );
          } else {
            healthStatus.className = `inline-flex items-center space-x-2 px-6 py-3 rounded-full glass-morphism shadow-lg ${healthStatusClasses["status-unhealthy"]}`;
            healthStatus.innerHTML =
              '<i data-lucide="alert-triangle" class="w-4 h-4 text-red-400"></i><span class="font-medium">Some services unavailable</span>';
            addLog(
              "error",
              "SYSTEM",
              "Health check failed - Check backend services"
            );
          }
          // Re-initialize Lucide icons for the new content
          lucide.createIcons();
        } catch (error) {
          const healthStatus = document.getElementById("health-status");
          healthStatus.className = `inline-flex items-center space-x-2 px-6 py-3 rounded-full glass-morphism shadow-lg ${healthStatusClasses["status-unhealthy"]}`;
          healthStatus.innerHTML =
            '<i data-lucide="wifi-off" class="w-4 h-4 text-red-400 animate-pulse"></i><span class="font-medium">Cannot connect to server</span>';
          // Re-initialize Lucide icons for the new content
          lucide.createIcons();
          addLog("error", "SYSTEM", "Failed to connect to Budsy server");
        }
      }

      // Event listeners
      function setupEventListeners() {
        document
          .getElementById("platform")
          .addEventListener("change", updatePlatformFields);
        document
          .getElementById("test-form")
          .addEventListener("submit", handleStartTest);
        document
          .getElementById("stop-btn")
          .addEventListener("click", handleStopTest);
        document
          .getElementById("download-logs-btn")
          .addEventListener("click", handleDownloadLogs);
        document
          .getElementById("clear-logs-btn")
          .addEventListener("click", clearLogs);
      }

      // Update form fields based on platform
      function updatePlatformFields() {
        const platform = document.getElementById("platform").value;
        const urlLabel = document.getElementById("url-label");
        const urlInput = document.getElementById("url");

        if (platform === "web") {
          urlLabel.innerHTML =
            '<i data-lucide="link" class="w-4 h-4 mr-2 text-slate-400"></i>Website URL';
          urlInput.placeholder = "https://example.com";
          urlInput.type = "url";
        } else {
          urlLabel.innerHTML =
            '<i data-lucide="smartphone" class="w-4 h-4 mr-2 text-slate-400"></i>App Path/Package';
          urlInput.placeholder =
            platform === "android"
              ? "com.example.app or /path/to/app.apk"
              : "MyApp.app";
          urlInput.type = "text";
        }
        // Re-initialize Lucide icons for the new content
        lucide.createIcons();
      }

      // Handle test start
      async function handleStartTest(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const testData = {
          instruction: formData.get("instruction").trim(),
          url: formData.get("url").trim(),
          platform: formData.get("platform"),
          testMode: formData.get("testMode"),
          expectedResult: formData.get("expectedResult").trim(),
          options: {},
        };

        // Validation
        if (!testData.instruction) {
          showAlert("error", "Test instruction is required.");
          return;
        }

        if (testData.platform === "web" && !testData.url) {
          showAlert("error", "Website URL is required for web testing.");
          return;
        }

        if (testData.platform !== "web" && !testData.url) {
          showAlert(
            "error",
            "App path/package is required for mobile testing."
          );
          return;
        }

        try {
          clearAlerts();
          clearLogs();

          const response = await axios.post("/api/tests/start", testData);
          currentTestId = response.data.testId;
          lastCompletedTestId = null;
          testStartTime = new Date();

          socket.emit("join_test", currentTestId);

          updateTestStatus("starting");
          document.getElementById("start-btn").style.display = "none";
          document.getElementById("stop-btn").style.display = "inline-flex";

          addLog(
            "info",
            "TEST",
            `Test started: ${testData.instruction.substring(0, 100)}...`
          );
          addLog(
            "info",
            "TEST",
            `Platform: ${testData.platform}, Mode: ${testData.testMode}, URL: ${testData.url}`
          );
        } catch (error) {
          showAlert(
            "error",
            `Failed to start test: ${
              error.response?.data?.error || error.message
            }`
          );
          addLog(
            "error",
            "TEST",
            `Failed to start test: ${
              error.response?.data?.error || error.message
            }`
          );
        }
      }

      // Handle test stop
      async function handleStopTest() {
        if (!currentTestId) return;

        try {
          await axios.post(`/api/tests/${currentTestId}/stop`);
          addLog("info", "TEST", "Test stop requested");
        } catch (error) {
          addLog("error", "TEST", `Failed to stop test: ${error.message}`);
        }
      }

      // Handle test completed
      function handleTestCompleted(data) {
        const duration = Date.now() - testStartTime;
        const result = data.result;

        updateTestStatus("completed");

        document.getElementById("stop-btn").style.display = "none";
        document.getElementById("start-btn").style.display = "inline-flex";
        document.getElementById("download-logs-btn").style.display =
          "inline-flex";
        updateDownloadButtonText();

        const resultDiv = document.getElementById("test-result");
        resultDiv.className = `mt-8 p-6 rounded-2xl ${
          result.success
            ? "bg-green-900/30 border-l-4 border-green-400"
            : "bg-red-900/30 border-l-4 border-red-400"
        }`;
        resultDiv.innerHTML = `
                <div class="flex items-center mb-4">
                    <i data-lucide="${
                      result.success ? "party-popper" : "x-circle"
                    }" class="w-8 h-8 mr-3 ${
          result.success ? "text-green-400" : "text-red-400"
        }"></i>
                    <h3 class="text-xl font-bold ${
                      result.success ? "text-green-200" : "text-red-200"
                    }">
                        ${
                          result.success
                            ? "Test Completed Successfully!"
                            : "Test Failed"
                        }
                    </h3>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="font-medium text-slate-300">Status:</span>
                            <span class="font-semibold ${
                              result.success ? "text-green-300" : "text-red-300"
                            }">${result.success ? "PASSED" : "FAILED"}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-slate-300">Duration:</span>
                            <span class="font-semibold text-slate-200">${Math.round(
                              duration / 1000
                            )}s</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="font-medium text-slate-300">Steps:</span>
                            <span class="font-semibold text-slate-200">${
                              result.stepsExecuted
                            }</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-slate-300">Screenshots:</span>
                            <span class="font-semibold text-slate-200">${
                              result.screenshots
                            }</span>
                        </div>
                    </div>
                </div>
                ${
                  result.verification
                    ? `
                    <div class="mt-4 p-4 bg-slate-800/30 rounded-lg border border-slate-600/20">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium text-slate-300">AI Confidence:</span>
                            <span class="font-bold text-blue-300">${(
                              result.verification.confidence * 100
                            ).toFixed(1)}%</span>
                        </div>
                        <div class="text-sm text-slate-300">
                            <span class="font-medium">Analysis:</span> ${
                              result.verification.result
                            }
                        </div>
                    </div>
                `
                    : ""
                }
            `;
        resultDiv.style.display = "block";
        // Re-initialize Lucide icons for the new content
        lucide.createIcons();
        resultDiv.style.display = "block";

        socket.emit("leave_test", currentTestId);
        lastCompletedTestId = currentTestId;
        currentTestId = null;
      }

      // Handle test failed
      function handleTestFailed(data) {
        const duration = Date.now() - testStartTime;

        updateTestStatus("failed");

        document.getElementById("stop-btn").style.display = "none";
        document.getElementById("start-btn").style.display = "inline-flex";
        document.getElementById("download-logs-btn").style.display =
          "inline-flex";
        updateDownloadButtonText();

        const resultDiv = document.getElementById("test-result");
        resultDiv.className =
          "mt-8 p-6 rounded-2xl bg-red-900/30 border-l-4 border-red-400";
        resultDiv.innerHTML = `
                <div class="flex items-center mb-4">
                    <i data-lucide="x-circle" class="w-8 h-8 mr-3 text-red-400"></i>
                    <h3 class="text-xl font-bold text-red-200">Test Failed</h3>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="font-medium text-slate-300">Duration:</span>
                        <span class="font-semibold text-slate-200">${Math.round(
                          duration / 1000
                        )}s</span>
                    </div>
                    <div>
                        <span class="font-medium text-slate-300">Error:</span>
                        <p class="mt-1 p-3 bg-red-800/30 rounded-lg text-red-200 font-medium border border-red-600/30">${
                          data.error
                        }</p>
                    </div>
                    <div class="p-3 bg-blue-900/30 rounded-lg border border-blue-600/30">
                        <div class="flex items-start space-x-2">
                            <i data-lucide="info" class="w-4 h-4 text-blue-400 mt-0.5 flex-shrink-0"></i>
                            <p class="text-blue-200">Logs have been automatically prepared for download. Click "Download Logs" to get detailed information about the failure.</p>
                        </div>
                    </div>
                </div>
            `;
        resultDiv.style.display = "block";
        // Re-initialize Lucide icons for the new content
        lucide.createIcons();
        resultDiv.style.display = "block";

        showAlert(
          "error",
          "Test execution failed. Check the logs for details and download them for further analysis."
        );

        socket.emit("leave_test", currentTestId);
        lastCompletedTestId = currentTestId;
        currentTestId = null;
      }

      // Handle test stopped
      function handleTestStopped(data) {
        updateTestStatus("stopped");

        document.getElementById("stop-btn").style.display = "none";
        document.getElementById("start-btn").style.display = "inline-flex";
        document.getElementById("download-logs-btn").style.display =
          "inline-flex";
        updateDownloadButtonText();

        addLog("info", "TEST", "Test stopped by user");

        socket.emit("leave_test", currentTestId);
        lastCompletedTestId = currentTestId;
        currentTestId = null;
      }

      // Update test status with enhanced styling
      function updateTestStatus(status) {
        const statusDiv = document.getElementById("test-status");
        let iconName, iconColor, text, className;

        switch (status) {
          case "starting":
          case "initializing":
            iconName = "loader";
            iconColor = "text-yellow-400 animate-spin";
            text = "Initializing test environment...";
            className = "status-running";
            break;
          case "running":
            iconName = "play-circle";
            iconColor = "text-blue-400";
            text = "Test execution in progress...";
            className = "status-running";
            break;
          case "completed":
            iconName = "check-circle";
            iconColor = "text-green-400";
            text = "Test completed successfully!";
            className = "status-completed";
            break;
          case "failed":
            iconName = "x-circle";
            iconColor = "text-red-400";
            text = "Test execution failed";
            className = "status-failed";
            break;
          case "stopped":
            iconName = "pause-circle";
            iconColor = "text-orange-400";
            text = "Test stopped";
            className = "status-failed";
            break;
          default:
            iconName = "circle";
            iconColor = "text-green-400 fill-current";
            text = "Ready to start testing";
            className = "status-idle";
        }

        statusDiv.className = `inline-flex items-center space-x-2 px-4 py-2 rounded-full glass-morphism ${statusClasses[className]}`;
        statusDiv.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5 ${iconColor}"></i><span class="font-medium">${text}</span>`;

        // Re-initialize Lucide icons for the new content
        lucide.createIcons();
      }

      // Enhanced log entry with better styling
      function addLog(
        level,
        component,
        message,
        data = null,
        isLoading = false,
        loadingId = null
      ) {
        const logsContainer = document.getElementById("logs-container");
        const logEntry = document.createElement("div");

        const timestamp = new Date().toLocaleTimeString();
        const dataString = data ? ` | ${JSON.stringify(data)}` : "";

        const logIcons = {
          info: "info",
          success: "check-circle",
          error: "x-circle",
          warn: "alert-triangle",
          debug: "bug",
        };

        logEntry.className = `log-entry flex items-start space-x-3 mb-3 p-3 rounded-lg border-l-4 ${
          logLevelClasses[`log-${level}`]
        }`;

        if (isLoading && loadingId) {
          logEntry.id = `loading-${loadingId}`;
          logEntry.className += " loading-entry shimmer-effect";
        }

        const loadingIcon = isLoading
          ? '<i data-lucide="loader" class="w-4 h-4 animate-spin mr-2 text-blue-400"></i>'
          : "";
        const levelIcon = logIcons[level] || "info";

        logEntry.innerHTML = `
                <span class="text-slate-500 text-xs mt-1 whitespace-nowrap font-mono">[${timestamp}]</span>
                <div class="flex-1">
                    <div class="flex items-center">
                        <strong class="text-xs mr-3 px-2 py-1 rounded bg-slate-600/30 text-slate-300 font-mono">[${component}]</strong>
                        <i data-lucide="${levelIcon}" class="w-4 h-4 mr-2"></i>
                        ${loadingIcon}
                        <span class="font-medium">${message}</span>
                    </div>
                    ${
                      dataString
                        ? `<div class="text-xs mt-1 opacity-75 font-mono text-slate-400">${dataString}</div>`
                        : ""
                    }
                </div>
            `;

        logsContainer.appendChild(logEntry);

        // Re-initialize Lucide icons for the new content
        lucide.createIcons();

        if (document.getElementById("auto-scroll").checked) {
          logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        return logEntry;
      }

      // Update loading entry to completed state
      function updateLoadingEntry(
        loadingId,
        level,
        component,
        message,
        data = null
      ) {
        const loadingEntry = document.getElementById(`loading-${loadingId}`);
        if (loadingEntry) {
          const timestamp = new Date().toLocaleTimeString();
          const dataString = data ? ` | ${JSON.stringify(data)}` : "";

          const logIcons = {
            info: "info",
            success: "check-circle",
            error: "x-circle",
            warn: "alert-triangle",
            debug: "bug",
          };

          const levelIcon = logIcons[level] || "info";

          loadingEntry.className = `log-entry flex items-start space-x-3 mb-3 p-3 rounded-lg border-l-4 ${
            logLevelClasses[`log-${level}`]
          }`;
          loadingEntry.innerHTML = `
                    <span class="text-slate-500 text-xs mt-1 whitespace-nowrap font-mono">[${timestamp}]</span>
                    <div class="flex-1">
                        <div class="flex items-center">
                            <strong class="text-xs mr-3 px-2 py-1 rounded bg-slate-600/30 text-slate-300 font-mono">[${component}]</strong>
                            <i data-lucide="${levelIcon}" class="w-4 h-4 mr-2"></i>
                            <span class="font-medium">${message}</span>
                        </div>
                        ${
                          dataString
                            ? `<div class="text-xs mt-1 opacity-75 font-mono text-slate-400">${dataString}</div>`
                            : ""
                        }
                    </div>
                `;
          // Re-initialize Lucide icons for the updated content
          lucide.createIcons();
        }
      }

      function addLoadingLog(component, message, loadingId, data = null) {
        return addLog("info", component, message, data, true, loadingId);
      }

      function clearLogs() {
        const container = document.getElementById("logs-container");
        container.innerHTML = `
                <div class="log-entry log-info flex items-start space-x-3 mb-3 p-3 rounded-lg bg-blue-500/20 border-l-4 border-blue-400">
                    <span class="text-slate-500 text-xs mt-1 font-mono">[System]</span>
                    <div class="flex items-center flex-1">
                        <i data-lucide="info" class="w-4 h-4 mr-2 text-blue-400"></i>
                        <span class="text-blue-200 font-medium">
                            Logs cleared. Ready for new test execution.
                        </span>
                    </div>
                </div>
            `;
        // Re-initialize Lucide icons for the new content
        lucide.createIcons();
      }

      // Enhanced alert styling
      function showAlert(type, message) {
        const alertsDiv = document.getElementById("test-alerts");
        const alert = document.createElement("div");
        const icons = {
          info: "info",
          warning: "alert-triangle",
          error: "x-circle",
        };

        alert.className = `p-4 rounded-xl border-l-4 ${
          alertClasses[`alert-${type}`]
        } flex items-start space-x-3 mb-4 shadow-lg`;
        alert.innerHTML = `
                <i data-lucide="${icons[type]}" class="w-5 h-5 flex-shrink-0 mt-0.5"></i>
                <div class="flex-1">
                    <p class="font-medium">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="flex-shrink-0 text-slate-400 hover:text-slate-200 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            `;
        alertsDiv.appendChild(alert);

        // Re-initialize Lucide icons for the new content
        lucide.createIcons();

        setTimeout(() => {
          if (alert.parentElement) {
            alert.remove();
          }
        }, 5000);
      }

      function clearAlerts() {
        document.getElementById("test-alerts").innerHTML = "";
      }

      function updateDownloadButtonText() {
        const downloadBtn = document.getElementById("download-logs-btn");
        const testIdToDownload = currentTestId || lastCompletedTestId;

        if (currentTestId) {
          downloadBtn.innerHTML =
            '<i data-lucide="download" class="w-4 h-4 mr-2"></i>Download Logs (Current Test)';
          downloadBtn.title = `Download logs for test: ${currentTestId}`;
        } else if (lastCompletedTestId) {
          downloadBtn.innerHTML =
            '<i data-lucide="download" class="w-4 h-4 mr-2"></i>Download Logs (Last Test)';
          downloadBtn.title = `Download logs for completed test: ${lastCompletedTestId}`;
        } else {
          downloadBtn.innerHTML =
            '<i data-lucide="download" class="w-4 h-4 mr-2"></i>Download Logs';
          downloadBtn.title = "No logs available";
        }
        // Re-initialize Lucide icons for the new content
        lucide.createIcons();
      }

      async function handleDownloadLogs() {
        const testIdToDownload = currentTestId || lastCompletedTestId;

        if (!testIdToDownload) {
          showAlert(
            "warning",
            "No test logs available to download. Please run a test first."
          );
          return;
        }

        try {
          addLog(
            "info",
            "SYSTEM",
            `Downloading logs for test: ${testIdToDownload}`
          );
          window.open(`/api/tests/${testIdToDownload}/logs/download`, "_blank");
          addLog("info", "SYSTEM", "Log download initiated");
        } catch (error) {
          showAlert("error", "Failed to download logs.");
          addLog("error", "SYSTEM", `Log download failed: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
