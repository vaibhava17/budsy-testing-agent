<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budsy Testing Agent - Web Interface</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .logo {
            font-family: 'Courier New', monospace;
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        .tagline {
            color: #666;
            font-size: 1.2em;
        }
        .test-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        input[type="text"], input[type="url"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #5a67d8;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .logs {
            background: #1e1e1e;
            color: #f0f0f0;
            padding: 20px;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            display: none;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .log-info { color: #61dafb; }
        .log-success { color: #98fb98; }
        .log-error { color: #ff6b6b; }
        .log-warn { color: #ffd93d; }
        .log-debug { color: #888; }
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .health-status {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .health-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-healthy { background: #28a745; }
        .status-unhealthy { background: #dc3545; }
        .status-unknown { background: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">BUDSY</div>
            <div class="tagline">ü§ñ AI-Powered UI Testing Agent</div>
        </div>

        <div class="health-status" id="healthStatus">
            <div class="health-item">
                <div class="status-indicator status-unknown" id="webStatus"></div>
                <span>Web Server</span>
            </div>
            <div class="health-item">
                <div class="status-indicator status-unknown" id="aiStatus"></div>
                <span>AI Backend</span>
            </div>
            <div class="health-item">
                <div class="status-indicator status-unknown" id="appiumStatus"></div>
                <span>Appium Server</span>
            </div>
        </div>

        <div class="test-form">
            <h3>Create AI-Guided Test</h3>
            <form id="testForm">
                <div class="form-group">
                    <label for="testUrl">Website URL:</label>
                    <input type="url" id="testUrl" placeholder="https://example.com/login" required>
                </div>
                
                <div class="form-group">
                    <label for="testInstruction">Natural Language Instruction:</label>
                    <textarea id="testInstruction" placeholder="Example: Go to sign in page, enter email test@example.com and password 123456, then click login button and verify dashboard appears" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="expectedResult">Expected Result (Optional):</label>
                    <input type="text" id="expectedResult" placeholder="User should be logged in and see dashboard">
                </div>
                
                <div class="form-group">
                    <label for="testMode">AI Test Mode:</label>
                    <select id="testMode">
                        <option value="visual">Visual Testing (AI analyzes screenshots and clicks coordinates)</option>
                        <option value="iterative">Iterative Testing (AI provides step-by-step feedback)</option>
                        <option value="traditional">Traditional Testing (Uses CSS selectors)</option>
                    </select>
                </div>
                
                <button type="submit" class="btn" id="startTestBtn">üöÄ Start AI-Guided Test</button>
            </form>
        </div>

        <div class="test-controls" style="display: none;" id="testControls">
            <button class="btn" id="stopTestBtn" style="background: #dc3545;">‚èπÔ∏è Stop Test</button>
            <button class="btn" id="downloadLogsBtn" style="background: #28a745;">üì• Download Logs</button>
        </div>

        <div class="status" id="statusMessage"></div>

        <div class="logs" id="logsContainer">
            <h4 style="color: #f0f0f0; margin-top: 0;">Real-time Test Logs</h4>
            <div id="logEntries"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentTestId = null;
        
        // DOM elements
        const testForm = document.getElementById('testForm');
        const statusMessage = document.getElementById('statusMessage');
        const logsContainer = document.getElementById('logsContainer');
        const logEntries = document.getElementById('logEntries');
        const testControls = document.getElementById('testControls');
        const startTestBtn = document.getElementById('startTestBtn');
        const stopTestBtn = document.getElementById('stopTestBtn');
        const downloadLogsBtn = document.getElementById('downloadLogsBtn');

        // Check health status on load
        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const health = await response.json();
                
                document.getElementById('webStatus').className = 'status-indicator status-healthy';
                document.getElementById('aiStatus').className = `status-indicator ${health.services.ai_backend ? 'status-healthy' : 'status-unhealthy'}`;
                document.getElementById('appiumStatus').className = `status-indicator ${health.services.appium ? 'status-healthy' : 'status-unhealthy'}`;
            } catch (error) {
                console.error('Health check failed:', error);
                document.getElementById('webStatus').className = 'status-indicator status-unhealthy';
            }
        }

        // Show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            statusMessage.style.display = 'block';
        }

        // Add log entry
        function addLogEntry(log) {
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry log-${log.level}`;
            const timestamp = new Date(log.timestamp).toLocaleTimeString();
            logDiv.innerHTML = `<span style="color: #888">[${timestamp}]</span> <span style="color: #ffd93d">[${log.component}]</span> ${log.message}`;
            logEntries.appendChild(logDiv);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // Start test
        testForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                url: document.getElementById('testUrl').value,
                instruction: document.getElementById('testInstruction').value,
                expectedResult: document.getElementById('expectedResult').value,
                testMode: document.getElementById('testMode').value,
                platform: 'web',
                options: {
                    context: {
                        source: 'web_interface',
                        timestamp: new Date().toISOString()
                    }
                }
            };

            try {
                startTestBtn.disabled = true;
                startTestBtn.textContent = 'üîÑ Starting Test...';
                showStatus('Initializing AI-guided test execution...', 'info');

                const response = await fetch('/api/tests/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentTestId = result.testId;
                    socket.emit('join_test', currentTestId);
                    
                    showStatus(`üöÄ AI-guided test started (${result.testMode} mode)`, 'success');
                    logsContainer.style.display = 'block';
                    testControls.style.display = 'flex';
                    
                    logEntries.innerHTML = '';
                    addLogEntry({
                        timestamp: new Date().toISOString(),
                        level: 'info',
                        component: 'WEB-UI',
                        message: `Test session ${currentTestId} started with instruction: "${formData.instruction}"`
                    });
                } else {
                    throw new Error(result.error || 'Failed to start test');
                }
            } catch (error) {
                showStatus(`‚ùå Failed to start test: ${error.message}`, 'error');
                startTestBtn.disabled = false;
                startTestBtn.textContent = 'üöÄ Start AI-Guided Test';
            }
        });

        // Stop test
        stopTestBtn.addEventListener('click', async () => {
            if (!currentTestId) return;

            try {
                await fetch(`/api/tests/${currentTestId}/stop`, { method: 'POST' });
                showStatus('üõë Test stop requested', 'info');
            } catch (error) {
                showStatus(`‚ùå Failed to stop test: ${error.message}`, 'error');
            }
        });

        // Download logs
        downloadLogsBtn.addEventListener('click', () => {
            if (!currentTestId) return;
            window.open(`/api/tests/${currentTestId}/logs/download`);
        });

        // Socket event handlers
        socket.on('log', (log) => {
            addLogEntry(log);
        });

        socket.on('test_completed', (result) => {
            showStatus(`‚úÖ Test completed successfully! Executed ${result.stepsExecuted} steps in ${(result.duration/1000).toFixed(1)}s`, 'success');
            startTestBtn.disabled = false;
            startTestBtn.textContent = 'üöÄ Start AI-Guided Test';
            testControls.style.display = 'none';
            
            addLogEntry({
                timestamp: new Date().toISOString(),
                level: 'success',
                component: 'WEB-UI',
                message: `Test session completed successfully with ${result.stepsExecuted} steps`
            });
        });

        socket.on('test_failed', (result) => {
            showStatus(`‚ùå Test failed: ${result.error}`, 'error');
            startTestBtn.disabled = false;
            startTestBtn.textContent = 'üöÄ Start AI-Guided Test';
            testControls.style.display = 'none';
            
            addLogEntry({
                timestamp: new Date().toISOString(),
                level: 'error',
                component: 'WEB-UI',
                message: `Test session failed: ${result.error}`
            });
        });

        socket.on('test_stopped', () => {
            showStatus('üõë Test stopped by user', 'info');
            startTestBtn.disabled = false;
            startTestBtn.textContent = 'üöÄ Start AI-Guided Test';
            testControls.style.display = 'none';
        });

        // Initialize
        checkHealth();
        
        // Example instructions
        const exampleInstructions = [
            "Navigate to login page, enter email 'test@example.com' and password 'password123', then click login",
            "Go to registration page, fill out the form with test data, and complete signup",
            "Search for 'laptop' in the search box, click on the first result, and add it to cart",
            "Go to profile settings, update the user name to 'John Doe', and save changes"
        ];
        
        // Add example instruction on page load
        document.addEventListener('DOMContentLoaded', () => {
            const instructionField = document.getElementById('testInstruction');
            instructionField.placeholder = exampleInstructions[Math.floor(Math.random() * exampleInstructions.length)];
        });
    </script>
</body>
</html>